#### 线程、进程、浏览器内核

### CPU、进程、线程

都知道Javascript是**单线程**的。那单线程是什么意思？先巩固如下概念：

**1、CPU：中央处理器** <br/>
&emsp;计算机的核心是CPU，它承担了全部的计算任务。<small class="blue-code">如一座工厂</small>

**2、进程：CPU能处理的单个任务** <br/>
&emsp;进程是CPU资源分配的最小单位，是能拥有资源和独立运行的最小单位。 <br/>
&emsp;对于计算机来说，每一个应用程序都是一个进程，而有些应用又有多个功能模块，每个模块都是经过**子进程**实现，我们称它为使多进程的。 <small class="blue-code">如一个流水线</small>

**3、线程：CPU能调度的最小单位** <br/>
&emsp;线程是CPU创建在进程的基础上的一次程序运行单位，不可再分割。一个进程可以有多个线程。 <small class="blue-code">如流水线上的操作员</small>

**单线程**指的是CPU在执行任务时的只使用一个线程去完成，由于线程不可再分割，因此所有任务必须等待前一个任务执行完成后再进入执行栈。

**多线程**则允许CPU在同一时间调度不同的线程*并行执行*任务。

!> 所谓JS是单线程的，是因为在浏览器执行JS代码时只通过JS引擎线程去运行执行栈里的代码，这个线程指JS引擎线程。
也有其他线程如定时任务线程，负责执行定时任务计时。不理解请继续往下阅读。

<br/>

### 浏览器是多进程的

&emsp; 我们给Chrome浏览器打开多个页签，可以在任务管理器里看到多个`chrome.exe`的进程，因为Chrome的每一个页签都是通过一个子进程去实现的。有如下几种进程： <br/>
**1、主进程：**<br/>
（1）协调控制其余子进程（建立、销毁）；<br/>
（2）浏览器界面显示，用户交互，前进、后退、收藏；<br/>
（3）将渲染进程获得的内存中的Bitmap，绘制到用户界面上；<br/>
（4）处理不可见操做，网络请求，文件访问等 <br/>
**2、GPU进程：** 用于3D绘制等 <br/>
**3、第三方插件进程：** 使用第三方插件时自动建立的进程 <br/>
<span class="bold red">4、渲染进程：即：浏览器内核</span>：负责页面渲染，脚本执行，事件处理等

<br/>

### 浏览器内核（渲染进程）

&emsp; 一个进程包含了多条线程，对于渲染进程来说，也是如此，它有5个线程：
- **GUI线程**
  - 负责渲染页面，布局和绘制
  - 页面须要重绘和回流时，该线程就会执行
  - <span class="blue">与js引擎线程互斥，防止渲染时JS线程在改动DOM导致渲染出来与实际不一致情况</span>
- **JS引擎线程**
  - 负责处理解析和执行javascript脚本程序
  - 只有一个JS引擎线程（单线程）
  - <span class="red">管理执行栈</span>
  - <span class="blue">与GUI渲染线程互斥，理由同上</span>
- **定时触发器线程**
  - setInterval与setTimeout所在的线程
  - 定时任务并非由JS引擎计时的，是由定时触发线程来计时的
  - 计时完毕后，通知事件触发线程将回调函数加入任务队列
- **异步http请求线程**
  - 浏览器有一个单独的线程用于处理AJAX请求
  - 当请求完成时，如有回调函数，通知事件触发线程将回调函数加入任务队列
- **事件触发线程**
  - 用来控制事件循环（鼠标点击、setTimeout、ajax等）
  - <span class="red">管理任务队列</span>，当事件满足触发条件时，将事件放入到JS引擎所在的执行队列中

!>平时说的，在html引入资源时，要把js文件放到文件底部，否则js执行会阻塞UI渲染，正是因为GUI线程和JS线程互斥所致。

<br/>

### 各线程与事件循环配合关系

&emsp; JS分为同步任务和异步任务，同步任务都在JS引擎线程上执行，形成一个<span class="red-code">执行栈</span>。事件触发线程管理一个<span class="red-code">任务队列</span>，当异步任务触发条件达成时，将回调函数放入任务队列中。在执行栈中的全部同步任务执行完成时，此时JS引擎空闲，系统就会读取任务队列，将可运行的一步任务回调时间添加懂到执行栈中执行。
&emsp; 
![event loop](https://img-blog.csdnimg.cn/13d8acef5b124903ac5da2c789b6d674.png)

&emsp; 如使用setTimeout来指定定时任务。当代码执行到setTimeout片段时，由JS引擎线程通知定时触发器线程，间隔指定时间出发一个回调事件。在setTimeout自身执行时，由于它自己是同步任务，会加入到执行栈中执行，而它的回调函数是异步任务，当定时器时间到达时，将回调函数加入任务队列中，等待执行栈的JS引擎线程空闲后，来读取执行。

![事件循环与渲染进程的关系](https://img-blog.csdnimg.cn/363e2791e42f4056b8ecb0e6d1c94a73.png)


**总结就是：**

- JS引擎线程只执行执行栈中的事件
- 执行栈中的代码执行完毕，就会读取事件队列中的事件
- 事件队列中的回调事件，是由各自线程插入到事件队列中的
- 以上三步进行事件循环